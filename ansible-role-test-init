#!/bin/bash
mkdir -p tests/cases

if [ ! -f ./tests/run ];then
    curl -s https://raw.githubusercontent.com/tumf/ansible-role-test-init/master/ansible-role-test-run > ./tests/run
    chmod +x ./tests/run
    echo 'Put ./tests/run' >&2
fi

if [ ! -f ./tests/test.yml ];then
    cat >./tests/test.yml <<EOF
---
- hosts: 127.0.0.1
  connection: local
  tags:
    - default
  roles:
    - role: ../..
EOF
    echo 'Put ./tests/test.yml' >&2
fi


if [ ! -f ./travis.yml ];then
    cat >.travis.yml <<EOF
language: python
python:
- '2.7'
install:
- pip install ansible
before_script:
- ansible --version
- ansible-playbook --syntax-check ./tests/test.yml -i ./tests/hosts
script:
- ./tests/run
EOF
    echo 'Put .travis.yml' >&2
fi

if ! grep '^prefix_dir:' defaults/main.yml >/dev/null 2>&1;then
    echo 'prefix_dir: ""' >>defaults/main.yml
    echo 'Add `prefix_dir: ""` to defaults/main.yml' >&2
fi

if ! grep '^ansible_unit_test:' defaults/main.yml >/dev/null 2>&1;then
    echo 'ansible_unit_test: false' >>defaults/main.yml
    echo 'Add `ansible_unit_test: false` to defaults/main.yml' >&2
fi

if ! grep '^/tests/outputs' .gitignore >/dev/null 2>&1;then
    echo '/tests/outputs' >>.gitignore
    echo 'Add `/tests/outputs` to .gitignore' >&2
fi
